<html>
  <head>
    {% load static %}
    <script src="{% static 'sharefiles/js/md5.js' %}"></script>
    <script src="{% static 'sharefiles/js/script.js' %}"></script>
    <script>
      async function handleUpload() {
        // get the input element by id "file"
        var input = document.getElementById("file");
        // get the first file from the input element's files property
        var file = input.files[0];
        // if there is no file selected, alert a message and return
        if (!file) {
          alert("Please select a file");
          return;
        }
        // set the chunk size to 5M
        var size = 5;
        // calculate the md5 hash of the file using the md5 function
        md5File(file)
          .then(async function (hash) {
            // display the hash in the span element by id "hash"
            document.getElementById("hash").textContent = hash;
            // split the file into chunks using the split function
            var chunks = split(file, size);
            // display the number of chunks in the span element by id "chunks"
            document.getElementById("chunks").textContent = chunks.length;
            // store the chunks, hash and file name in global variables for later use
            window.chunks = chunks;
            window.hash = hash;
            window.filename = file.name;

            // check if file exists
            check_upload_status();

            // Start checking upload status at regular intervals
            var checkStatusInterval = setInterval(check_upload_status, 500); // 0.5 seconds

            // loop through the chunks
            for (var i = 0; i < chunks.length; i++) {
              // get the current chunk and its index
              var chunk = chunks[i];
              var index = i + 1;
              // send the chunk and other fields using the send function
              await send(chunk, index, chunks.length, hash, file.name, 2);
            }
            // Stop checking upload status when it is done
            if(...){
              clearInterval(checkStatusInterval);
            }
            // create instance if ok
            create_file_instance();
          })
          .catch(function (error) {
            // if there is an error calculating the hash, alert a message and log the error to the console
            alert("Error calculating md5 hash");
            console.error(error);
          });
      }
    </script>
  </head>
  <body>
    {% comment %}
    <h1>File Upload Demo</h1>
    <p>Select a file and enter a chunk size in bytes:</p>
    <input type="file" id="file" />
    <input type="number" id="size" value="1" />M
    <button onclick="calculate()">Calculate</button>
    <p>MD5 hash: <span id="hash"></span></p>
    <p>Number of chunks: <span id="chunks"></span></p>
    <input type="number" id="folder_id" value="1" />folder id
    <button onclick="sendAll()">Send</button>
    <button onclick="check_upload_status()">Status</button>
    <button onclick="create_file_instance()">Create</button>
    <p>Status: <span id="status"></span></p>
    {% endcomment %}
    <hr />
    <h1>File Upload Demo</h1>
    <p>Select a file:</p>
    <input type="file" id="file" />
    <button onclick="handleUpload()">Upload</button>
    <p>MD5 hash: <span id="hash"></span></p>
    <p>Number of chunks: <span id="chunks"></span></p>
    <p>Status: <span id="status"></span></p>
  </body>
</html>
